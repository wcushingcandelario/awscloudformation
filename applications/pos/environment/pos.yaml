---
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Application: POS ElasticBeanstalk environment template.'
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'VPC Parent Stack'
      Parameters:
      - ParentVPCStack
    - Label:
        default: 'Environment Setup'
      Parameters:
      - EnvironmentType
      - ProjectName
      - InstanceType
      - SSHKeyName
    - Label:
        default: 'Environment Configuration'
      Parameters:
      - APPDATAIMPORTER_ASYNC
      - APPDATAIMPORTER_USELOCALHASHCODES
      - ATG_ECOMMERCE_CUSTOMER_CLIENT_ID
      - ATG_ECOMMERCE_CUSTOMER_CLIENT_SECRET
      - ATG_ECOMMERCE_CUSTOMER_GRANT_TYPE
      - ATG_ECOMMERCE_CUSTOMER_HOST
      - ATG_ECOMMERCE_CUSTOMER_PORT
      - ATG_ECOMMERCE_CUSTOMER_SCHEME
      - ATG_ECOMMERCE_CUSTOMER_TOKEN_HOST
      - ATG_ECOMMERCE_CUSTOMER_TOKEN_PORT
      - ATG_ECOMMERCE_CUSTOMER_TOKEN_URL
      - ATG_ECOMMERCE_CUSTOMER_URL
      - COMM_ADJUST_EXPORT_URL
      - COMM_PO_ASN_URL
      - COMM_PO_SUBMIT_URL
      - COMM_RETURN_EXPORT_URL
      - COMM_STOCKSYNC_URL
      - COMM_STOCK_EXPORT_URL
      - COMM_TLOG_URL
      - CUSTDATAIMPORTER_ASYNC
      - CUSTDATAIMPORTER_IGNOREJSONVALIDATIONERRORS
      - EXPORT_PRODUCT_CATALOG_NAME
      - EXPORT_PRODUCT_TYPE
      - GRANT_TYPE_PWD
      - IMPORTER_MODE
      - IMPORTFILES_EXTERNALUSERDIR
      - IMPORTFILES_POSTPRODUCTSIMPORTSDIR
      - IMPORTFILES_ROOTLOCATIONSDIR
      - IMPORTFILES_STANDALONEIMPORTSDIR
      - IMPORT_CANCELDRAFTORDER_URL
      - IMPORT_COMPLETEORDER_URL
      - IMPORT_ENDPOINT_TEMP_LOCATION
      - IMPORT_FORCECLOSEORDER_URL
      - IMPORT_LOCPRODUCT_FROMSTOCK
      - IMPORT_REPLENISHMENT_URL
      - IMPORT_STOCKEXPORT_URL
      - IMPORT_STOCK_BALANCETYPE
      - IMPORT_STOCK_HOST
      - IMPORT_STOCK_OAUTH_CODE_URL
      - IMPORT_STOCK_OAUTH_CODE_VALUE
      - IMPORT_STOCK_OAUTH_PORT
      - IMPORT_STOCK_PORT
      - IMPORT_STOCK_SCHEME
      - IMPORT_STOCK_TYPE
      - IMPORT_STOCK_URL
      - JNDI_DS_URL
      - NEW_RELIC_APP_NAME
      - NEW_RELIC_LICENSE_KEY
      - NEW_RELIC_LOG
      - OAUTH_ENDPOINT_URL
      - OAUTH_REQUIRED
      - OVCDB_DB
      - OVCDB_DRIVER
      - OVCDB_ENCRYPTED_PASSWORD
      - OVCDB_HOST
      - OVCDB_PARAMS
      - OVCDB_PORT
      - OVCDB_SCHEME
      - OVCDB_USERNAME
      - OVCNOSQLDB_DB
      - OVCNOSQLDB_URI
      - OVCSERVER_ADOPATH
      - OVCSERVER_CUSTOMER-ALL
      - OVCSERVER_HOST
      - OVCSERVER_IMPORTFILESPATH
      - OVCSERVER_PORT
      - OVCSERVER_PROP_DIR
      - OVCSERVER_REPO_LOC
      - OVCSERVER_SCHEME
      - OVCSERVER_WEBCONTEXT
      - PASSWORD
      - POSMCLIENTSYNCUPDATER_BROWSER
      - POSMCLIENTSYNCUPDATER_CONCURRENTDEVICES
      - POSMCLIENTSYNCUPDATER_CONCURRENTSTORES
      - POSMCLIENTSYNCUPDATER_STORE
      - SCOPE
      - USERNAME
    ParameterLabels:
      EnvironmentType:
        default: "Specify the type of environment this instance will be used in."

Parameters:
  ParentVPCStack:
    Description: 'Stack name of parent VPC stack based on vpc/vpc-*azs.yaml template.'
    Type: String
  EnvironmentType:
    Description: Environment Type.
    Default: dev
    Type: String
    AllowedValues:
      - dev
      - development
      - qa
      - uat
      - sit
      - test
      - rc
      - preproduction
      - production
      - other
    ConstraintDescription: Specify the type of environment this instance will be used in.
  InstanceType:
    Description: Instance Type.
    Type: String
    Default: t2.large
    ConstraintDescription: 'The type of instance that the POS will run on eg. t2.small, m3.medium, etc'
  SSHKeyName:
    Description: SSH Key Name.
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: 'The SSH key pair that is used for SSH to the instances.'
  NewRelicLicenseKey:
    Description: NewRelic license key.
    Type: String
    Default: ''
  MinASGSize:
    Description: 'Minimum number of instances running'
    Type: Number
    Default: 1
  MaxASGSize:
    Description: 'Maximum number of instances running'
    Type: Number
    Default: 3
  HostedZoneId:
    Description: 'The Hosted Zone ID used to create Record Sets (URLs)'
    Type: String
  HostedZoneIdPublic:
    Description: 'PUBLIC Hosted Zone Id for the Route53 domain to create the ELB DNS entry.'
    Type: String
  HostedZoneDomainName:
    Description: 'The Domain Name with extension used to create Record Sets (URLs). eg: ovcdemo.com'
    Type: String
  SolutionStackName:
    Description: 'The solution stack used'
    Type: String
  APPDATAIMPORTER_ASYNC:
    Description: APPDATAIMPORTER_ASYNC
    Default: true
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  APPDATAIMPORTER_USELOCALHASHCODES:
    Description: APPDATAIMPORTER_USELOCALHASHCODES
    Default: true
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_CLIENT_ID:
    Description: ATG_ECOMMERCE_CUSTOMER_CLIENT_ID
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_CLIENT_SECRET:
    Description: ATG_ECOMMERCE_CUSTOMER_CLIENT_SECRET
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_GRANT_TYPE:
    Description: ATG_ECOMMERCE_CUSTOMER_GRANT_TYPE
    Default: client_credentials
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_HOST:
    Description: ATG_ECOMMERCE_CUSTOMER_HOST
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_PORT:
    Description: ATG_ECOMMERCE_CUSTOMER_PORT
    Default: 8443
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_SCHEME:
    Description: ATG_ECOMMERCE_CUSTOMER_SCHEME
    Default: https
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_TOKEN_HOST:
    Description: ATG_ECOMMERCE_CUSTOMER_TOKEN_HOST
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_TOKEN_PORT:
    Description: ATG_ECOMMERCE_CUSTOMER_TOKEN_PORT
    Default: 443
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_TOKEN_URL:
    Description: ATG_ECOMMERCE_CUSTOMER_TOKEN_URL
    Default: /v1/identity/token
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  ATG_ECOMMERCE_CUSTOMER_URL:
    Description: ATG_ECOMMERCE_CUSTOMER_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  COMM_ADJUST_EXPORT_URL:
    Description: COMM_ADJUST_EXPORT_URL
    Default: /rest/model/atg/userprofiling/v1/profile/
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  COMM_PO_ASN_URL:
    Description: COMM_PO_ASN_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  COMM_PO_SUBMIT_URL:
    Description: COMM_PO_SUBMIT_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  COMM_RETURN_EXPORT_URL:
    Description: COMM_RETURN_EXPORT_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  COMM_STOCKSYNC_URL:
    Description: COMM_STOCKSYNC_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  COMM_STOCK_EXPORT_URL:
    Description: COMM_STOCK_EXPORT_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  COMM_TLOG_URL:
    Description: COMM_TLOG_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  CUSTDATAIMPORTER_ASYNC:
    Description: CUSTDATAIMPORTER_ASYNC
    Default: false
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  CUSTDATAIMPORTER_IGNOREJSONVALIDATIONERRORS:
    Description: CUSTDATAIMPORTER_IGNOREJSONVALIDATIONERRORS
    Default: true
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  EXPORT_PRODUCT_CATALOG_NAME:
    Description: EXPORT_PRODUCT_CATALOG_NAME
    Default: apparelProductCatalog
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  EXPORT_PRODUCT_TYPE:
    Description: EXPORT_PRODUCT_TYPE
    Default: ApparelProduct
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  GRANT_TYPE_PWD:
    Description: GRANT_TYPE_PWD
    Default: password
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORTER_MODE:
    Description: IMPORTER_MODE
    Default: production
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORTFILES_EXTERNALUSERDIR:
    Description: IMPORTFILES_EXTERNALUSERDIR
    Default: importDefaultExternalUser
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORTFILES_POSTPRODUCTSIMPORTSDIR:
    Description: IMPORTFILES_POSTPRODUCTSIMPORTSDIR
    Default: eCommerceImportFiles2
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORTFILES_ROOTLOCATIONSDIR:
    Description: IMPORTFILES_ROOTLOCATIONSDIR
    Default: importRootLocations
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORTFILES_STANDALONEIMPORTSDIR:
    Description: IMPORTFILES_STANDALONEIMPORTSDIR
    Default: eCommerceImportFiles
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_CANCELDRAFTORDER_URL:
    Description: IMPORT_CANCELDRAFTORDER_URL
    Default: cancelDraftOrder
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_COMPLETEORDER_URL:
    Description: IMPORT_COMPLETEORDER_URL
    Default: api_updateCompleted
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_ENDPOINT_TEMP_LOCATION:
    Description: IMPORT_ENDPOINT_TEMP_LOCATION
    Default: /tmp
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_FORCECLOSEORDER_URL:
    Description: IMPORT_FORCECLOSEORDER_URL
    Default: forceCloseOrder
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_LOCPRODUCT_FROMSTOCK:
    Description: IMPORT_LOCPRODUCT_FROMSTOCK
    Default: false
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_REPLENISHMENT_URL:
    Description: IMPORT_REPLENISHMENT_URL
    Default: api_createreplenishmentorder
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCKEXPORT_URL:
    Description: IMPORT_STOCKEXPORT_URL
    Default: stockbalances
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_BALANCETYPE:
    Description: IMPORT_STOCK_BALANCETYPE
    Default: ats
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_HOST:
    Description: IMPORT_STOCK_HOST
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_OAUTH_CODE_URL:
    Description: IMPORT_STOCK_OAUTH_CODE_URL
    Default: /oauth/code
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_OAUTH_CODE_VALUE:
    Description: IMPORT_STOCK_OAUTH_CODE_VALUE
    Default: jmsuser
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_OAUTH_PORT:
    Description: IMPORT_STOCK_OAUTH_PORT
    Default: 3009
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_PORT:
    Description: IMPORT_STOCK_PORT
    Default: 3007
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_SCHEME:
    Description: IMPORT_STOCK_SCHEME
    Default: https
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_TYPE:
    Description: IMPORT_STOCK_TYPE
    Default: product
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  IMPORT_STOCK_URL:
    Description: IMPORT_STOCK_URL
    Default: stockbalances
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  JNDI_DS_URL:
    Description: JNDI_DS_URL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  NEW_RELIC_APP_NAME:
    Description: NEW_RELIC_APP_NAME
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  NEW_RELIC_LICENSE_KEY:
    Description: NEW_RELIC_LICENSE_KEY
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  NEW_RELIC_LOG:
    Description: NEW_RELIC_LOG
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OAUTH_ENDPOINT_URL:
    Description: OAUTH_ENDPOINT_URL
    Default: /oauth/token
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OAUTH_REQUIRED:
    Description: OAUTH_REQUIRED
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_DB:
    Description: OVCDB_DB
    Default: xdb
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_DRIVER:
    Description: OVCDB_DRIVER
    Default: org.mariadb.jdbc.Driver
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_ENCRYPTED_PASSWORD:
    Description: OVCDB_ENCRYPTED_PASSWORD
    Default: L3Q5kQqII0OlaJ9FGCaukQ==
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_HOST:
    Description: OVCDB_HOST
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_PARAMS:
    Description: OVCDB_PARAMS
    Default: autoReconnect=true
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_PORT:
    Description: OVCDB_PORT
    Default: 3306
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_SCHEME:
    Description: OVCDB_SCHEME
    Default: jdbc:mysql
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCDB_USERNAME:
    Description: OVCDB_USERNAME
    Default: root
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCNOSQLDB_DB:
    Description: OVCNOSQLDB_DB
    Default: xdb
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCNOSQLDB_URI:
    Description: OVCNOSQLDB_URI
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_ADOPATH:
    Description: OVCSERVER_ADOPATH
    Default:  /opt/ovc/Application-Dynamic-Objects
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_CUSTOMER-ALL:
    Description: OVCSERVER_CUSTOMER-ALL
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_HOST:
    Description: OVCSERVER_HOST
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_IMPORTFILESPATH:
    Description: OVCSERVER_IMPORTFILESPATH
    Default: /opt/ovc/Base-Location-Import-Files/ovc-all-OvcStore
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_PORT:
    Description: OVCSERVER_PORT
    Default: 443
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_PROP_DIR:
    Description: OVCSERVER_PROP_DIR
    Default: /opt/ovc/Platform-Dynamic-Objects/config
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_REPO_LOC:
    Description: OVCSERVER_REPO_LOC
    Default: /opt/ovc/Platform-Dynamic-Objects
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_SCHEME:
    Description: OVCSERVER_SCHEME
    Default: https
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  OVCSERVER_WEBCONTEXT:
    Description: OVCSERVER_WEBCONTEXT
    Default: /
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  PASSWORD:
    Description: PASSWORD
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  POSMCLIENTSYNCUPDATER_BROWSER:
    Description: POSMCLIENTSYNCUPDATER_BROWSER
    Default: true
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  POSMCLIENTSYNCUPDATER_CONCURRENTDEVICES:
    Description: POSMCLIENTSYNCUPDATER_CONCURRENTDEVICES
    Default: 4
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  POSMCLIENTSYNCUPDATER_CONCURRENTSTORES:
    Description: POSMCLIENTSYNCUPDATER_CONCURRENTSTORES
    Default: 4
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  POSMCLIENTSYNCUPDATER_STORE:
    Description: POSMCLIENTSYNCUPDATER_STORE
    Default: All
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  SCOPE:
    Description: SCOPE
    Default: extended
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.
  USERNAME:
    Description: USERNAME
    Default: customermanager
    Type: String
    ConstraintDescription: Specify the URL for the OVC server.

Conditions:
  NewRelicKeyPresent: !Not
    - !Equals
      - ''
      - !Ref NewRelicLicenseKey

Resources:
  POSServerEnvironment:
    Type: "AWS::ElasticBeanstalk::Environment"
    Properties:
      ApplicationName:
        'Fn::ImportValue': POSApplication
      Description: POS
      EnvironmentName: !Sub '${EnvironmentType}-pos'
      SolutionStackName: !Ref SolutionStackName
      OptionSettings:

        # Scaling Settings
        - Namespace: aws:autoscaling:asg
          OptionName: MinSize
          Value: !Ref MinASGSize
        - Namespace: aws:autoscaling:asg
          OptionName: MaxSize
          Value: !Ref MaxASGSize
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value: LoadBalanced
        - Namespace: aws:autoscaling:updatepolicy:rollingupdate
          OptionName: RollingUpdateEnabled
          Value: true
        - Namespace: aws:autoscaling:updatepolicy:rollingupdate
          OptionName: RollingUpdateType
          Value: Health

        # VPC Network Settings
        - Namespace: aws:ec2:vpc
          OptionName: VPCId
          Value:
            'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'
        - Namespace: aws:ec2:vpc
          OptionName: Subnets
          Value:
            'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetsAppPrivate'
        - Namespace: aws:ec2:vpc
          OptionName: ELBSubnets
          Value:
            'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetsPublic'
        - Namespace: aws:ec2:vpc
          OptionName: AssociatePublicIpAddress
          Value: true

        # Settings
        - Namespace: aws:elasticbeanstalk:healthreporting:system
          OptionName: SystemType
          Value: enhanced
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: SecurityGroups
          Value:
            'Fn::ImportValue': !Sub '${ParentVPCStack}-POSServerSecurityGroup'

        # Environment Settings
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: ServiceRole
          Value:
            'Fn::ImportValue': ElasticBeanstalkSerivceRole
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value:
            'Fn::ImportValue': ElasticBeanstalkInstanceRoleInstanceProfile

          # ELB Settings
        - Namespace: aws:elb:loadbalancer
          OptionName: CrossZone
          Value: true

        - Namespace: aws:ec2:vpc
          OptionName: ELBScheme
          Value: internal

          # Scaling Settings
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: InstanceType
          Value: !Ref InstanceType
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: EC2KeyName
          Value: !Ref SSHKeyName

          # NewRelic Variables
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: APPDATAIMPORTER_ASYNC
          Value: !Ref APPDATAIMPORTER_ASYNC
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: APPDATAIMPORTER_USELOCALHASHCODES
          Value: !Ref APPDATAIMPORTER_USELOCALHASHCODES
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_CLIENT_ID
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_CLIENT_ID
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_CLIENT_SECRET
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_CLIENT_SECRET
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_GRANT_TYPE
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_GRANT_TYPE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_HOST
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_HOST
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_PORT
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_PORT
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_SCHEME
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_SCHEME
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_TOKEN_HOST
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_TOKEN_HOST
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_TOKEN_PORT
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_TOKEN_PORT
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_TOKEN_URL
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_TOKEN_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ATG_ECOMMERCE_CUSTOMER_URL
          Value: !Ref ATG_ECOMMERCE_CUSTOMER_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: COMM_ADJUST_EXPORT_URL
          Value: !Ref COMM_ADJUST_EXPORT_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: COMM_PO_ASN_URL
          Value: !Ref COMM_PO_ASN_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: COMM_PO_SUBMIT_URL
          Value: !Ref COMM_PO_SUBMIT_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: COMM_RETURN_EXPORT_URL
          Value: !Ref COMM_RETURN_EXPORT_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: COMM_STOCKSYNC_URL
          Value: !Ref COMM_STOCKSYNC_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: COMM_STOCK_EXPORT_URL
          Value: !Ref COMM_STOCK_EXPORT_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: COMM_TLOG_URL
          Value: !Ref COMM_TLOG_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: CUSTDATAIMPORTER_ASYNC
          Value: !Ref CUSTDATAIMPORTER_ASYNC
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: CUSTDATAIMPORTER_IGNOREJSONVALIDATIONERRORS
          Value: !Ref CUSTDATAIMPORTER_IGNOREJSONVALIDATIONERRORS
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: EXPORT_PRODUCT_CATALOG_NAME
          Value: !Ref EXPORT_PRODUCT_CATALOG_NAME
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: EXPORT_PRODUCT_TYPE
          Value: !Ref EXPORT_PRODUCT_TYPE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: GRANT_TYPE_PWD
          Value: !Ref GRANT_TYPE_PWD
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORTER_MODE
          Value: !Ref IMPORTER_MODE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORTFILES_EXTERNALUSERDIR
          Value: !Ref IMPORTFILES_EXTERNALUSERDIR
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORTFILES_POSTPRODUCTSIMPORTSDIR
          Value: !Ref IMPORTFILES_POSTPRODUCTSIMPORTSDIR
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORTFILES_ROOTLOCATIONSDIR
          Value: !Ref IMPORTFILES_ROOTLOCATIONSDIR
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORTFILES_STANDALONEIMPORTSDIR
          Value: !Ref IMPORTFILES_STANDALONEIMPORTSDIR
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_CANCELDRAFTORDER_URL
          Value: !Ref IMPORT_CANCELDRAFTORDER_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_COMPLETEORDER_URL
          Value: !Ref IMPORT_COMPLETEORDER_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_ENDPOINT_TEMP_LOCATION
          Value: !Ref IMPORT_ENDPOINT_TEMP_LOCATION
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_FORCECLOSEORDER_URL
          Value: !Ref IMPORT_FORCECLOSEORDER_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_LOCPRODUCT_FROMSTOCK
          Value: !Ref IMPORT_LOCPRODUCT_FROMSTOCK
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_REPLENISHMENT_URL
          Value: !Ref IMPORT_REPLENISHMENT_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCKEXPORT_URL
          Value: !Ref IMPORT_STOCKEXPORT_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_BALANCETYPE
          Value: !Ref IMPORT_STOCK_BALANCETYPE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_HOST
          Value: !Ref IMPORT_STOCK_HOST
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_OAUTH_CODE_URL
          Value: !Ref IMPORT_STOCK_OAUTH_CODE_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_OAUTH_CODE_VALUE
          Value: !Ref IMPORT_STOCK_OAUTH_CODE_VALUE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_OAUTH_PORT
          Value: !Ref IMPORT_STOCK_OAUTH_PORT
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_PORT
          Value: !Ref IMPORT_STOCK_PORT
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_SCHEME
          Value: !Ref IMPORT_STOCK_SCHEME
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_TYPE
          Value: !Ref IMPORT_STOCK_TYPE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: IMPORT_STOCK_URL
          Value: !Ref IMPORT_STOCK_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: JNDI_DS_URL
          Value: !Ref JNDI_DS_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: NEW_RELIC_APP_NAME
          Value: !If
            - NewRelicKeyPresent
            - !Sub '${EnvironmentType}-pos'
            - !Ref 'AWS::NoValue'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: NEW_RELIC_LICENSE_KEY
          Value: !If
            - NewRelicKeyPresent
            - !Ref NewRelicLicenseKey
            - !Ref 'AWS::NoValue'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: NEW_RELIC_LOG
          Value: !If
            - NewRelicKeyPresent
            - '/var/log/newrelic_agent.log'
            - !Ref 'AWS::NoValue'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OAUTH_ENDPOINT_URL
          Value: !Ref OAUTH_ENDPOINT_URL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OAUTH_REQUIRED
          Value: !Ref OAUTH_REQUIRED
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_DB
          Value: !Ref OVCDB_DB
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_DRIVER
          Value: !Ref OVCDB_DRIVER
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_ENCRYPTED_PASSWORD
          Value: !Ref OVCDB_ENCRYPTED_PASSWORD
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_HOST
          Value: !Ref OVCDB_HOST
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_PARAMS
          Value: !Ref OVCDB_PARAMS
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_PORT
          Value: !Ref OVCDB_PORT
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_SCHEME
          Value: !Ref OVCDB_SCHEME
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCDB_USERNAME
          Value: !Ref OVCDB_USERNAME
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCNOSQLDB_DB
          Value: !Ref OVCNOSQLDB_DB
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCNOSQLDB_URI
          Value: !Ref OVCNOSQLDB_URI
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_ADOPATH
          Value: !Ref OVCSERVER_ADOPATH
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_CUSTOMER-ALL
          Value: !Ref OVCSERVER_CUSTOMER-ALL
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_HOST
          Value: !Ref OVCSERVER_HOST
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_IMPORTFILESPATH
          Value: !Ref OVCSERVER_IMPORTFILESPATH
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_PORT
          Value: !Ref OVCSERVER_PORT
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_PROP_DIR
          Value: !Ref OVCSERVER_PROP_DIR
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_REPO_LOC
          Value: !Ref OVCSERVER_REPO_LOC
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_SCHEME
          Value: !Ref OVCSERVER_SCHEME
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: OVCSERVER_WEBCONTEXT
          Value: !Ref OVCSERVER_WEBCONTEXT
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: PASSWORD
          Value: !Ref PASSWORD
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: POSMCLIENTSYNCUPDATER_BROWSER
          Value: !Ref POSMCLIENTSYNCUPDATER_BROWSER
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: POSMCLIENTSYNCUPDATER_CONCURRENTDEVICES
          Value: !Ref POSMCLIENTSYNCUPDATER_CONCURRENTDEVICES
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: POSMCLIENTSYNCUPDATER_CONCURRENTSTORES
          Value: !Ref POSMCLIENTSYNCUPDATER_CONCURRENTSTORES
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: POSMCLIENTSYNCUPDATER_STORE
          Value: !Ref POSMCLIENTSYNCUPDATER_STORE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SCOPE
          Value: !Ref SCOPE
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: USERNAME
          Value: !Ref USERNAME

          # Environment Variables
        # - Namespace: aws:elasticbeanstalk:application:environment
        #   OptionName: MONGO_URL
        #   Value: !Ref MONGOURL

      Tags:
        - Key: "Role"
          Value: "POS"
        - Key: "Environment"
          Value: !Ref EnvironmentType
        - Key: "Project"
          Value:
            'Fn::ImportValue': !Sub '${ParentVPCStack}-ProjectName'
        - Key: LiveIdentifier
          Value:
            'Fn::ImportValue': !Sub '${ParentVPCStack}-LiveIdentifier'

  DNSRecord:
    Type: AWS::Route53::RecordSet
    DependsOn: POSServerEnvironment
    Properties:
      HostedZoneId:
        !Ref 'HostedZoneId'
      Name: !Join ['', [!Sub '${EnvironmentType}-pos', ., !Ref 'HostedZoneDomainName']]
      Type: CNAME
      TTL: '60'
      ResourceRecords:
      - !GetAtt POSServerEnvironment.EndpointURL

  PublicLoadBalancer:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      Subnets:
        - 'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetAPublic'
        - 'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetBPublic'
        - 'Fn::ImportValue': !Sub '${ParentVPCStack}-SubnetCPublic'
      Listeners:
      - InstancePort: 80
        InstanceProtocol: TCP
        LoadBalancerPort: 443
        Protocol: SSL
        SSLCertificateId: !Ref CertificateId
      HealthCheck:
        HealthyThreshold: 2
        Interval: 15
        Target: 'HTTPS:443/'
        Timeout: 10
        UnhealthyThreshold: 3
      SecurityGroups:
      - 'Fn::ImportValue': !Sub '${ParentVPCStack}-POSLoadBalancerSecurityGroup'
      - !Ref PublicPOSLoadBalancerCustomerAccessSecurityGroup
      Scheme: 'internet-facing'
      CrossZone: !Ref CrossZoneLoadBalancing
      Tags:
      - Key: Environment
        Value: !Ref EnvironmentType
      - Key: Project
        Value:
          'Fn::ImportValue': !Sub '${ParentVPCStack}-ProjectName'
      - Key: LiveIdentifier
        Value:
          'Fn::ImportValue': !Sub '${ParentVPCStack}-LiveIdentifier'

  PublicLoadBalancerDNSEntry:
    Type: AWS::Route53::RecordSet
    DependsOn: PublicLoadBalancer
    Properties:
      HostedZoneId: !Ref 'HostedZoneIdPublic'
      Comment: !Sub '${ParentVPCStack}-POSServer-PublicLoadBalancer'
      Name: !Join ['', [!Sub '${EnvironmentType}-pos', ., !Ref 'HostedZoneDomainName']]
      Type: CNAME
      TTL: '60'
      ResourceRecords:
      - !GetAtt PublicLoadBalancer.DNSName

  POSServerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2008-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"

  POSServerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
      - Ref: POSServerRole

  POSServerPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "POSServer"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Action: "ec2:DescribeInstances"
            Resource: "*"
          -
            Effect: "Allow"
            Action: "ec2:DescribeTags"
            Resource: "*"
      Roles:
      - Ref: POSServerRole

  POSRolePolicies:
    Type: "AWS::IAM::Policy"
    DependsOn: POSServerRole
    Properties:
      PolicyName: POSQueuePermissions
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Action:
              - sqs:DeleteMessage
              - sqs:DeleteMessageBatch
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:ReceiveMessage
              - sqs:SendMessage
              - sqs:SendMessageBatch
            Resource:
              - !GetAtt 'QueueTLogs.Arn'
      Roles:
      - Ref: POSServerRole

  QueueTLogs:
    Type: "AWS::SQS::Queue"
    DependsOn: QueueTLogsDLQ
    Properties:
      MessageRetentionPeriod: !Ref MessageRetentionPeriodSetting
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - "QueueTLogsDLQ"
            - "Arn"
        maxReceiveCount: !Ref MaxReceiveCountSetting

  QueueTLogsDLQ:
    Type: "AWS::SQS::Queue"

  POSLoadBalancerCustomerAccessSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Load balancer incoming customer connections security group'
      VpcId:
        'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'
      Tags:
      - Key: Name
        Value:  POSLoadBalancerCustomerAccessSecurityGroup
      - Key: Project
        Value:
          'Fn::ImportValue': !Sub '${ParentVPCStack}-ProjectName'
      - Key: LiveIdentifier
        Value:
          'Fn::ImportValue': !Sub '${ParentVPCStack}-LiveIdentifier'
      SecurityGroupIngress:
      -
        FromPort: 443
        ToPort: 443
        IpProtocol: tcp
        CidrIp: !Ref CustomerPOSAccessCIDR1

  PublicPOSLoadBalancerCustomerAccessSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Load balancer incoming customer connections security group'
      VpcId:
        'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'
      Tags:
      - Key: Name
        Value:  POSLoadBalancerCustomerAccessSecurityGroup
      - Key: Project
        Value:
          'Fn::ImportValue': !Sub '${ParentVPCStack}-ProjectName'
      - Key: LiveIdentifier
        Value:
          'Fn::ImportValue': !Sub '${ParentVPCStack}-LiveIdentifier'
      SecurityGroupIngress:
      -
        FromPort: 443
        ToPort: 443
        IpProtocol: tcp
        CidrIp: 127.0.0.1/8
